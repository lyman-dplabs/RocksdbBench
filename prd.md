# RocksDB 基准测试产品需求文档 (PRD)

## 1. 项目背景与目标

为了评估 RocksDB 在模拟区块链分页索引和 Changeset 存储场景下的性能表现，我们设计并实施一套全面的基准测试方案。本项目旨在通过模拟真实世界的数据访问模式，量化 RocksDB 在写入、更新、查询等关键操作上的性能指标，为后续的系统优化和架构选型提供数据支持。

## 2. 核心需求

### 2.1. 数据结构模拟

系统需要模拟以下两种核心数据表：

#### 2.1.1. ChangeSet 表

- **功能**: 存储每个区块中键值的具体变更。
- **键 (Key)**: `block_num_be || addr#slot`
    - `block_num_be`: Big-endian 格式的区块号。
    - `addr#slot`: 地址和存储槽的组合。
    - *示例*: `"0000007A0000/0xabc#slot123"`
- **值 (Value)**: 32 字节的随机新值（避免全零值）。

#### 2.1.2. Index 表

- **功能**: 为每个键值创建一个分页索引，记录其在哪些区块中发生了变更。
- **键 (Key)**: `page_be || addr#slot`
    - `page_be`: Big-endian 格式的页码（每 1000 个区块为一页）。
    - `addr#slot`: 地址和存储槽的组合。
    - *示例*: `"000001/0xabc#slot123"`
- **值 (Value)**: 使用 `MergeOperator` 聚合一个变更过的区块号列表。
    - *初期实现*: 每个区块号使用定长的 8 字节。
    - *后期优化*: 可考虑使用 VarInt 进行压缩，以节省空间。

### 2.2. 数据规模与分布

- **初始键总数**: 1 亿。
- **键值分布**:
    - **热点 Key**: 1000 万 (写入概率 80%)
    - **中等活跃 Key**: 2000 万 (写入概率 10%)
    - **长尾 Key**: 7000 万 (写入概率 10%)

## 3. 测试场景设计

### 3.1. 阶段一：初始化写入测试

- **目标**: 测试纯粹的批量写入性能。
- **流程**: 一次性写入 1 亿条变更记录，每次写入 10,000 条，直到所有初始 Key 都被写入。写入时也需要写入ChangeSet和Index表

### 3.2. 阶段二：热点更新与查询测试

- **目标**: 模拟真实业务中带有热点访问的持续更新和周期性查询场景。
- **流程**:
    1. **模拟区块更新**:
        - 每个模拟区块更新 10,000 个 Key。
        - Key 的选择遵循 **2.2** 中定义的分布（8000 热点，1000 中等，1000 长尾）。
        - 每次更新操作需要同时写入 `ChangeSet` 表和 `Index` 表（通过 Merge 操作）。
    2. **周期性历史状态查询**:
        - 每处理 50 万个KV，执行一次随机历史状态查询。
        - **查询逻辑**: 模拟 `eth_call`，随机读取一批 Key 在某个历史区块的状态。
        - **性能要求**: 测试系统能否快速定位到对应的分页，并结合 Index 和 ChangeSet 表解析出历史值。

## 4. 关键性能指标 (KPIs)

需要收集和分析以下性能指标：

| 指标                 | 描述                                                         |
| -------------------- | ------------------------------------------------------------ |
| **写入吞吐量**       | 每轮写入 10,000 个 Key 所需的时间和吞吐速率 (MB/s)。          |
| **SST 合并效率**     | 监控 RocksDB 的 Compaction 过程的效率和资源消耗。            |
| **MergeOperator 聚合大小** | 分析 `Index` 表中由 MergeOperator 聚合的值的平均大小和增长趋势。 |
| **Bloom Filter 准确率** | 评估 Bloom Filter 在点查询场景下的过滤效率和误判率。       |
| **历史查询性能**     | 测量在周期性查询场景下，定位并解析一个 Key 历史状态所需的平均时间。 |
| **冷热 Key 命中分析**  | 分析缓存（如 Block Cache）对不同热度 Key 的命中率。         |

## 5. 交付物

- 一个可配置、可执行的基准测试程序。
- 一份详细的测试报告，包含对 **第 4 节** 中所有指标的分析图表和结论。
